generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                  String               @id @default(cuid())
  email               String               @unique
  password            String
  name                String
  role                UserRole
  branchId            String?
  isActive            Boolean              @default(true)
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
  attendance          Attendance[]
  cashDrawerSessions  CashDrawerSession[]
  messagesReceived    Message[]            @relation("MessagesReceived")
  messagesSent        Message[]            @relation("MessagesSent")
  passwordResetTokens PasswordResetToken[]
  createdProducts     Product[]            @relation("ProductCreator")
  transactions        Transaction[]
  branch              Branch?              @relation(fields: [branchId], references: [id])
  requestedTransfers  InterBranchTransfer[] @relation("Requester")
  approvedTransfers   InterBranchTransfer[] @relation("Approver")
  shippedTransfers    InterBranchTransfer[] @relation("Shipper")
  receivedTransfers   InterBranchTransfer[] @relation("Receiver")

  @@map("users")
}

model Branch {
  id                 String              @id @default(cuid())
  name               String
  address            String?
  phone              String?
  isActive           Boolean             @default(true)
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  attendance         Attendance[]
  cashDrawerSessions CashDrawerSession[]
  categories         Category[]
  chartOfAccounts    ChartOfAccount[]
  journalEntries     JournalEntry[]
  products           Product[]
  purchaseOrders     PurchaseOrder[]
  suppliers          Supplier[]
  transactions           Transaction[]
  users                  User[]
  customers              Customer[]
  interBranchTransfersFrom InterBranchTransfer[] @relation("FromBranch")
  interBranchTransfersTo   InterBranchTransfer[] @relation("ToBranch")

  @@map("branches")
}

model Category {
  id          String     @id @default(cuid())
  name        String
  code        String?    @unique
  description String?
  parentId    String?
  isActive    Boolean    @default(true)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  branchId    String?
  branch      Branch?    @relation(fields: [branchId], references: [id])
  parent      Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children    Category[] @relation("CategoryHierarchy")
  products    Product[]

  @@map("categories")
}

model Product {
  id               String            @id @default(cuid())
  sku              String            @unique
  barcode          String?
  name             String
  description      String?
  price            Decimal           @db.Decimal(10, 2)
  cost             Decimal           @db.Decimal(10, 2)
  stock            Int               @default(0)
  minStock         Int               @default(0)
  maxStock         Int               @default(0)
  unit             String            @default("pcs")
  weight           Decimal?          @db.Decimal(8, 3)
  dimensions       String?
  isActive         Boolean           @default(true)
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  createdBy        String
  categoryId       String?
  branchId         String
  inventoryLogs    InventoryLog[]
  branch           Branch            @relation(fields: [branchId], references: [id])
  category         Category?         @relation(fields: [categoryId], references: [id])
  creator          User              @relation("ProductCreator", fields: [createdBy], references: [id])
  purchaseItems       PurchaseItem[]
  transactionItems    TransactionItem[]
  interBranchTransferItems InterBranchTransferItem[]
  productBatches      ProductBatch[]

  @@map("products")
}

model Transaction {
  id              String            @id @default(cuid())
  transactionCode String            @unique
  totalAmount     Decimal           @db.Decimal(10, 2)
  discount        Decimal           @default(0) @db.Decimal(10, 2)
  tax             Decimal           @default(0) @db.Decimal(10, 2)
  finalAmount     Decimal           @db.Decimal(10, 2)
  paymentMethod   PaymentMethod
  amountPaid      Decimal           @db.Decimal(10, 2)
  change          Decimal           @db.Decimal(10, 2)
  status          TransactionStatus @default(COMPLETED)
  notes           String?
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  userId          String
  branchId        String
  items           TransactionItem[]
  branch          Branch            @relation(fields: [branchId], references: [id])
  user            User              @relation(fields: [userId], references: [id])
  batchMovements  BatchMovement[]

  @@map("transactions")
}

model TransactionItem {
  id            String      @id @default(cuid())
  quantity      Int
  unitPrice     Decimal     @db.Decimal(10, 2)
  discount      Decimal     @default(0) @db.Decimal(10, 2)
  total         Decimal     @db.Decimal(10, 2)
  transactionId String
  productId     String
  product       Product     @relation(fields: [productId], references: [id])
  transaction   Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)

  @@map("transaction_items")
}

model Supplier {
  id             String          @id @default(cuid())
  code           String          @unique
  name           String
  contact        String?
  address        String?
  phone          String?
  email          String?
  isActive       Boolean         @default(true)
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  branchId       String
  purchaseOrders PurchaseOrder[]
  branch         Branch          @relation(fields: [branchId], references: [id])

  @@map("suppliers")
}

model PurchaseOrder {
  id          String         @id @default(cuid())
  orderCode   String         @unique
  orderDate   DateTime
  totalAmount Decimal        @db.Decimal(10, 2)
  discount    Decimal        @default(0) @db.Decimal(10, 2)
  tax         Decimal        @default(0) @db.Decimal(10, 2)
  finalAmount Decimal        @db.Decimal(10, 2)
  status      String         @default("PENDING")
  notes       String?
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  supplierId  String
  branchId    String
  items       PurchaseItem[]
  branch      Branch         @relation(fields: [branchId], references: [id])
  supplier    Supplier       @relation(fields: [supplierId], references: [id])

  @@map("purchase_orders")
}

model PurchaseItem {
  id               String        @id @default(cuid())
  quantity         Int
  unitPrice        Decimal       @db.Decimal(10, 2)
  discount         Decimal       @default(0) @db.Decimal(10, 2)
  total            Decimal       @db.Decimal(10, 2)
  receivedQuantity Int           @default(0)
  status           String        @default("PENDING")
  purchaseOrderId  String
  productId        String
  product          Product       @relation(fields: [productId], references: [id])
  purchaseOrder    PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)

  @@map("purchase_items")
}

model InventoryLog {
  id        String   @id @default(cuid())
  type      String
  quantity  Int
  reference String?
  notes     String?
  createdAt DateTime @default(now())
  productId String
  product   Product  @relation(fields: [productId], references: [id])

  @@map("inventory_logs")
}

model Attendance {
  id        String    @id @default(cuid())
  date      DateTime
  checkIn   DateTime?
  checkOut  DateTime?
  status    String    @default("PRESENT")
  notes     String?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  userId    String
  branchId  String
  branch    Branch    @relation(fields: [branchId], references: [id])
  user      User      @relation(fields: [userId], references: [id])

  @@unique([userId, date])
  @@map("attendance")
}

model ChartOfAccount {
  id                String             @id @default(cuid())
  code              String             @unique
  name              String
  type              String
  parentId          String?
  isActive          Boolean            @default(true)
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  branchId          String
  branch            Branch             @relation(fields: [branchId], references: [id])
  parent            ChartOfAccount?    @relation("AccountHierarchy", fields: [parentId], references: [id])
  children          ChartOfAccount[]   @relation("AccountHierarchy")
  journalEntries    JournalEntry[]
  journalEntryItems JournalEntryItem[]

  @@map("chart_of_accounts")
}

model JournalEntry {
  id               String             @id @default(cuid())
  entryCode        String             @unique
  date             DateTime
  description      String
  reference        String?
  total            Decimal            @db.Decimal(15, 2)
  status           String             @default("POSTED")
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt
  branchId         String
  chartOfAccountId String?
  branch           Branch             @relation(fields: [branchId], references: [id])
  chartOfAccount   ChartOfAccount?    @relation(fields: [chartOfAccountId], references: [id])
  journalEntries   JournalEntryItem[]

  @@map("journal_entries")
}

model JournalEntryItem {
  id             String         @id @default(cuid())
  description    String
  debit          Decimal        @default(0) @db.Decimal(15, 2)
  credit         Decimal        @default(0) @db.Decimal(15, 2)
  journalEntryId String
  accountId      String
  account        ChartOfAccount @relation(fields: [accountId], references: [id])
  journalEntry   JournalEntry   @relation(fields: [journalEntryId], references: [id], onDelete: Cascade)

  @@map("journal_entry_items")
}

model CashDrawerSession {
  id             String               @id @default(cuid())
  sessionCode    String               @unique
  startTime      DateTime
  endTime        DateTime?
  initialCash    Decimal              @db.Decimal(10, 2)
  finalCash      Decimal?             @db.Decimal(10, 2)
  status         String               @default("OPEN")
  notes          String?
  createdAt      DateTime             @default(now())
  updatedAt      DateTime             @updatedAt
  branchId       String
  cashierId      String
  cashActivities CashDrawerActivity[]
  branch         Branch               @relation(fields: [branchId], references: [id])
  cashier        User                 @relation(fields: [cashierId], references: [id])

  @@map("cash_drawer_sessions")
}

model CashDrawerActivity {
  id          String            @id @default(cuid())
  type        String
  amount      Decimal           @db.Decimal(10, 2)
  description String?
  createdAt   DateTime          @default(now())
  sessionId   String
  session     CashDrawerSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@map("cash_drawer_activities")
}

model Message {
  id         String   @id @default(cuid())
  content    String
  isRead     Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  senderId   String
  receiverId String
  receiver   User     @relation("MessagesReceived", fields: [receiverId], references: [id])
  sender     User     @relation("MessagesSent", fields: [senderId], references: [id])

  @@map("messages")
}

model SystemSettings {
  id          String   @id @default(cuid())
  key         String   @unique
  value       String
  description String?
  updatedAt   DateTime @updatedAt

  @@map("system_settings")
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("password_reset_tokens")
}

enum UserRole {
  ADMIN
  MANAGER
  STAFF
}

enum PaymentMethod {
  CASH
  DEBIT_CARD
  CREDIT_CARD
  QRIS
}

enum TransactionStatus {
  PENDING
  COMPLETED
  CANCELLED
  REFUNDED
}

enum CustomerGender {
  MALE
  FEMALE
  OTHER
}

enum CustomerType {
  RETAIL
  REGULAR
  WHOLESALE
  VIP
}

enum ContactType {
  PHONE
  EMAIL
  ADDRESS
  EMERGENCY
}

enum LoyaltyPointType {
  EARNED
  REDEEMED
  EXPIRED
  ADJUSTED
}

enum TransferStatus {
  PENDING
  APPROVED
  IN_TRANSIT
  SHIPPED
  RECEIVED
  CANCELLED
}

model Customer {
  id                  String              @id @default(cuid())
  code                String              @unique
  customerCode        String?             @unique
  name                String
  email               String?
  phone               String?
  gender              CustomerGender?
  dateOfBirth         DateTime?
  type                CustomerType        @default(RETAIL)
  isActive            Boolean             @default(true)
  loyaltyPoints       Int                 @default(0)
  totalPurchases      Decimal             @default(0) @db.Decimal(15, 2)
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt
  branchId            String?
  address             String?
  city                String?
  postalCode          String?
  country             String?
  creator             String?
  contacts            CustomerContact[]
  transactions        CustomerTransaction[]
  points              LoyaltyPoint[]
  branch              Branch?             @relation(fields: [branchId], references: [id])

  @@map("customers")
}

model CustomerContact {
  id         String      @id @default(cuid())
  type       ContactType
  value      String
  isPrimary  Boolean     @default(false)
  createdAt  DateTime    @default(now())
  customerId String
  customer   Customer    @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@map("customer_contacts")
}

model CustomerTransaction {
  id              String      @id @default(cuid())
  transactionCode String      @unique
  amount          Decimal     @db.Decimal(15, 2)
  type            String      @default("PURCHASE")
  description     String?
  createdAt       DateTime    @default(now())
  customerId      String
  customer        Customer    @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@map("customer_transactions")
}

model LoyaltyPoint {
  id         String            @id @default(cuid())
  points     Int
  type       LoyaltyPointType
  description String?
  expiresAt  DateTime?
  isRedeemed Boolean           @default(false)
  createdAt  DateTime          @default(now())
  customerId String
  customer   Customer          @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@map("loyalty_points")
}

model InterBranchTransfer {
  id              String                    @id @default(cuid())
  transferCode    String                    @unique
  status          TransferStatus            @default(PENDING)
  notes           String?
  createdAt       DateTime                  @default(now())
  updatedAt       DateTime                  @updatedAt
  requestedAt     DateTime                  @default(now())
  totalAmount     Decimal                   @default(0) @db.Decimal(15, 2)
  fromBranchId    String
  toBranchId      String
  approvedBy      String?
  approvedAt      DateTime?
  receivedAt          DateTime?
  receivedBy          String?
  requestedBy         String?
  items               InterBranchTransferItem[]
  fromBranch          Branch                    @relation("FromBranch", fields: [fromBranchId], references: [id])
  toBranch            Branch                    @relation("ToBranch", fields: [toBranchId], references: [id])
  requester           User?                     @relation("Requester", fields: [requestedBy], references: [id])
  approver            User?                     @relation("Approver", fields: [approvedBy], references: [id])
  shipper             User?                     @relation("Shipper", fields: [shippedBy], references: [id])
  shippedBy           String?
  receiver            User?                     @relation("Receiver", fields: [receivedBy], references: [id])

  @@map("inter_branch_transfers")
}

model InterBranchTransferItem {
  id                String              @id @default(cuid())
  quantity          Int
  unitCost          Decimal             @default(0) @db.Decimal(10, 2)
  totalCost         Decimal             @default(0) @db.Decimal(10, 2)
  receivedQuantity  Int                 @default(0)
  status            String              @default("PENDING")
  notes             String?
  transferId        String
  transfer          InterBranchTransfer @relation(fields: [transferId], references: [id], onDelete: Cascade)
  productId         String
  product           Product             @relation(fields: [productId], references: [id])

  @@map("inter_branch_transfer_items")
}

model ProductBatch {
  id              String          @id @default(cuid())
  batchCode       String          @unique
  batchNumber     String?
  productId_batchNumber String?   @unique
  quantity        Int
  remainingQty    Int
  availableQty    Int             @default(0)
  costPrice       Decimal         @db.Decimal(10, 2)
  sellingPrice    Decimal         @db.Decimal(10, 2)
  cost            Decimal?        @db.Decimal(10, 2)
  lotNumber       String?
  location        String?
  status          String?         @default("ACTIVE")
  notes           String?
  manufactureDate DateTime?
  expiryDate      DateTime?
  supplier        String?
  isActive        Boolean         @default(true)
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  productId       String
  product         Product         @relation(fields: [productId], references: [id])
  movements       BatchMovement[]
  batchMovements  BatchMovement[] @relation("BatchMovements")

  @@map("product_batches")
}

model BatchMovement {
  id            String       @id @default(cuid())
  type          String       // IN, OUT, ADJUSTMENT, TRANSFER
  quantity      Int
  reference     String?
  notes         String?
  createdAt     DateTime     @default(now())
  batchId       String?
  productBatchId String?
  batch         ProductBatch? @relation(fields: [batchId], references: [id], onDelete: Cascade)
  productBatch  ProductBatch? @relation("BatchMovements", fields: [productBatchId], references: [id], onDelete: Cascade)
  transaction   Transaction?  @relation(fields: [transactionId], references: [id])
  transactionId String?

  @@map("batch_movements")
}
