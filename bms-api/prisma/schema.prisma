generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                 String              @id @default(cuid())
  email              String              @unique
  password           String
  name               String
  role               UserRole
  branchId           String?
  isActive           Boolean             @default(true)
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  attendance         Attendance[]
  cashDrawerSessions CashDrawerSession[]
  messagesReceived   Message[]           @relation("MessagesReceived")
  messagesSent       Message[]           @relation("MessagesSent")
  createdProducts    Product[]           @relation("ProductCreator")
  transactions       Transaction[]
  branch             Branch?             @relation(fields: [branchId], references: [id])
  passwordResetTokens PasswordResetToken[]
  createdCustomers    Customer[]           @relation("CustomerCreator")
  transfersRequested  InterBranchTransfer[] @relation("TransferRequester")
  transfersApproved   InterBranchTransfer[] @relation("TransferApprover")
  transfersShipped    InterBranchTransfer[] @relation("TransferShipper")
  transfersReceived   InterBranchTransfer[] @relation("TransferReceiver")

  @@map("users")
}

model Branch {
  id                 String              @id @default(cuid())
  name               String
  address            String?
  phone              String?
  isActive           Boolean             @default(true)
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  attendance         Attendance[]
  cashDrawerSessions CashDrawerSession[]
  categories         Category[]
  chartOfAccounts    ChartOfAccount[]
  journalEntries     JournalEntry[]
  products           Product[]
  purchaseOrders     PurchaseOrder[]
  suppliers          Supplier[]
  transactions       Transaction[]
  users              User[]
  customers          Customer[]
  taxRates           TaxRate[]
  taxConfigurations  TaxConfiguration[]
  stockAlerts        StockAlert[]
  stockAlertRules    StockAlertRule[]
  transfersFrom      InterBranchTransfer[] @relation("TransferFrom")
  transfersTo        InterBranchTransfer[] @relation("TransferTo")

  @@map("branches")
}

model Category {
  id          String     @id @default(cuid())
  name        String
  code        String?    @unique
  description String?
  parentId    String?
  isActive    Boolean    @default(true)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  branchId    String?
  branch      Branch?    @relation(fields: [branchId], references: [id])
  parent      Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children    Category[] @relation("CategoryHierarchy")
  products    Product[]

  @@map("categories")
}

model Product {
  id               String            @id @default(cuid())
  sku              String            @unique
  barcode          String?
  name             String
  description      String?
  price            Decimal           @db.Decimal(10, 2)
  cost             Decimal           @db.Decimal(10, 2)
  stock            Int               @default(0)
  minStock         Int               @default(0)
  maxStock         Int               @default(0)
  unit             String            @default("pcs")
  weight           Decimal?          @db.Decimal(8, 3)
  dimensions       String?
  isActive         Boolean           @default(true)
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  createdBy        String
  categoryId       String?
  branchId         String
  inventoryLogs    InventoryLog[]
  branch           Branch            @relation(fields: [branchId], references: [id])
  category         Category?         @relation(fields: [categoryId], references: [id])
  creator          User              @relation("ProductCreator", fields: [createdBy], references: [id])
  purchaseItems    PurchaseItem[]
  transactionItems TransactionItem[]
  batches          ProductBatch[]
  stockAlerts      StockAlert[]
  transferItems    InterBranchTransferItem[]

  @@map("products")
}

model Transaction {
  id              String            @id @default(cuid())
  transactionCode String            @unique
  totalAmount     Decimal           @db.Decimal(10, 2)
  discount        Decimal           @default(0) @db.Decimal(10, 2)
  tax             Decimal           @default(0) @db.Decimal(10, 2)
  finalAmount     Decimal           @db.Decimal(10, 2)
  paymentMethod   PaymentMethod
  amountPaid      Decimal           @db.Decimal(10, 2)
  change          Decimal           @db.Decimal(10, 2)
  status          TransactionStatus @default(COMPLETED)
  notes           String?
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  userId          String
  branchId        String
  items           TransactionItem[]
  branch          Branch            @relation(fields: [branchId], references: [id])
  user            User              @relation(fields: [userId], references: [id])
  customerTransaction CustomerTransaction?
  batchMovements   BatchMovement[]

  @@map("transactions")
}

model TransactionItem {
  id            String      @id @default(cuid())
  quantity      Int
  unitPrice     Decimal     @db.Decimal(10, 2)
  discount      Decimal     @default(0) @db.Decimal(10, 2)
  total         Decimal     @db.Decimal(10, 2)
  transactionId String
  productId     String
  product       Product     @relation(fields: [productId], references: [id])
  transaction   Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)

  @@map("transaction_items")
}

model Supplier {
  id             String          @id @default(cuid())
  code           String          @unique
  name           String
  contact        String?
  address        String?
  phone          String?
  email          String?
  isActive       Boolean         @default(true)
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  branchId       String
  purchaseOrders PurchaseOrder[]
  branch         Branch          @relation(fields: [branchId], references: [id])

  @@map("suppliers")
}

model PurchaseOrder {
  id          String         @id @default(cuid())
  orderCode   String         @unique
  orderDate   DateTime
  totalAmount Decimal        @db.Decimal(10, 2)
  discount    Decimal        @default(0) @db.Decimal(10, 2)
  tax         Decimal        @default(0) @db.Decimal(10, 2)
  finalAmount Decimal        @db.Decimal(10, 2)
  status      String         @default("PENDING")
  notes       String?
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  supplierId  String
  branchId    String
  items       PurchaseItem[]
  branch      Branch         @relation(fields: [branchId], references: [id])
  supplier    Supplier       @relation(fields: [supplierId], references: [id])

  @@map("purchase_orders")
}

model PurchaseItem {
  id               String        @id @default(cuid())
  quantity         Int
  unitPrice        Decimal       @db.Decimal(10, 2)
  discount         Decimal       @default(0) @db.Decimal(10, 2)
  total            Decimal       @db.Decimal(10, 2)
  receivedQuantity Int           @default(0)
  status           String        @default("PENDING")
  purchaseOrderId  String
  productId        String
  product          Product       @relation(fields: [productId], references: [id])
  purchaseOrder    PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)

  @@map("purchase_items")
}

model InventoryLog {
  id        String   @id @default(cuid())
  type      String
  quantity  Int
  reference String?
  notes     String?
  createdAt DateTime @default(now())
  productId String
  product   Product  @relation(fields: [productId], references: [id])

  @@map("inventory_logs")
}

model Attendance {
  id        String    @id @default(cuid())
  date      DateTime
  checkIn   DateTime?
  checkOut  DateTime?
  status    String    @default("PRESENT")
  notes     String?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  userId    String
  branchId  String
  branch    Branch    @relation(fields: [branchId], references: [id])
  user      User      @relation(fields: [userId], references: [id])

  @@unique([userId, date])
  @@map("attendance")
}

model ChartOfAccount {
  id                String             @id @default(cuid())
  code              String             @unique
  name              String
  type              String
  parentId          String?
  isActive          Boolean            @default(true)
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  branchId          String
  branch            Branch             @relation(fields: [branchId], references: [id])
  parent            ChartOfAccount?    @relation("AccountHierarchy", fields: [parentId], references: [id])
  children          ChartOfAccount[]   @relation("AccountHierarchy")
  journalEntries    JournalEntry[]
  journalEntryItems JournalEntryItem[]

  @@map("chart_of_accounts")
}

model JournalEntry {
  id               String             @id @default(cuid())
  entryCode        String             @unique
  date             DateTime
  description      String
  reference        String?
  total            Decimal            @db.Decimal(15, 2)
  status           String             @default("POSTED")
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt
  branchId         String
  chartOfAccountId String?
  branch           Branch             @relation(fields: [branchId], references: [id])
  chartOfAccount   ChartOfAccount?    @relation(fields: [chartOfAccountId], references: [id])
  journalEntries   JournalEntryItem[]

  @@map("journal_entries")
}

model JournalEntryItem {
  id             String         @id @default(cuid())
  description    String
  debit          Decimal        @default(0) @db.Decimal(15, 2)
  credit         Decimal        @default(0) @db.Decimal(15, 2)
  journalEntryId String
  accountId      String
  account        ChartOfAccount @relation(fields: [accountId], references: [id])
  journalEntry   JournalEntry   @relation(fields: [journalEntryId], references: [id], onDelete: Cascade)

  @@map("journal_entry_items")
}

model CashDrawerSession {
  id             String               @id @default(cuid())
  sessionCode    String               @unique
  startTime      DateTime
  endTime        DateTime?
  initialCash    Decimal              @db.Decimal(10, 2)
  finalCash      Decimal?             @db.Decimal(10, 2)
  status         String               @default("OPEN")
  notes          String?
  createdAt      DateTime             @default(now())
  updatedAt      DateTime             @updatedAt
  branchId       String
  cashierId      String
  cashActivities CashDrawerActivity[]
  branch         Branch               @relation(fields: [branchId], references: [id])
  cashier        User                 @relation(fields: [cashierId], references: [id])

  @@map("cash_drawer_sessions")
}

model CashDrawerActivity {
  id          String            @id @default(cuid())
  type        String
  amount      Decimal           @db.Decimal(10, 2)
  description String?
  createdAt   DateTime          @default(now())
  sessionId   String
  session     CashDrawerSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@map("cash_drawer_activities")
}

model Message {
  id         String   @id @default(cuid())
  content    String
  isRead     Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  senderId   String
  receiverId String
  receiver   User     @relation("MessagesReceived", fields: [receiverId], references: [id])
  sender     User     @relation("MessagesSent", fields: [senderId], references: [id])

  @@map("messages")
}

model SystemSettings {
  id          String   @id @default(cuid())
  key         String   @unique
  value       String
  description String?
  updatedAt   DateTime @updatedAt

  @@map("system_settings")
}

model PasswordResetToken {
  id         String   @id @default(cuid())
  token      String   @unique
  userId     String
  expiresAt  DateTime
  used       Boolean  @default(false)
  createdAt  DateTime @default(now())
  user       User     @relation(fields: [userId], references: [id])
  
  @@map("password_reset_tokens")
}

// Customer Management System
model Customer {
  id                String              @id @default(cuid())
  customerCode      String              @unique
  name              String
  email             String?
  phone             String?
  address           String?
  city              String?
  postalCode        String?
  country           String?             @default("Indonesia")
  dateOfBirth       DateTime?
  gender            CustomerGender?
  customerType      CustomerType        @default(REGULAR)
  creditLimit       Decimal             @default(0) @db.Decimal(10, 2)
  currentBalance    Decimal             @default(0) @db.Decimal(10, 2)
  loyaltyPoints     Int                 @default(0)
  totalPurchases    Decimal             @default(0) @db.Decimal(10, 2)
  lastPurchaseDate  DateTime?
  isActive          Boolean             @default(true)
  notes             String?
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  createdBy         String
  branchId          String
  branch            Branch              @relation(fields: [branchId], references: [id])
  creator           User                @relation("CustomerCreator", fields: [createdBy], references: [id])
  transactions      CustomerTransaction[]
  customerContacts  CustomerContact[]
  loyaltyPointsLog  LoyaltyPoint[]
  
  @@map("customers")
}

model CustomerContact {
  id         String   @id @default(cuid())
  type       ContactType
  value      String
  isPrimary  Boolean  @default(false)
  customerId String
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  
  @@map("customer_contacts")
}

model CustomerTransaction {
  id            String              @id @default(cuid())
  transactionId String              @unique
  amount        Decimal             @db.Decimal(10, 2)
  pointsEarned  Int                 @default(0)
  createdAt     DateTime            @default(now())
  customerId    String
  customer      Customer            @relation(fields: [customerId], references: [id])
  transaction   Transaction         @relation(fields: [transactionId], references: [id])
  
  @@map("customer_transactions")
}

model LoyaltyPoint {
  id          String            @id @default(cuid())
  points      Int
  type        LoyaltyPointType
  description String?
  expiresAt   DateTime?
  isRedeemed  Boolean           @default(false)
  createdAt   DateTime          @default(now())
  customerId  String
  customer    Customer          @relation(fields: [customerId], references: [id])
  
  @@map("loyalty_points")
}

// Batch & Lot Tracking System
model ProductBatch {
  id               String            @id @default(cuid())
  batchNumber      String
  lotNumber        String?
  expiryDate       DateTime?
  manufactureDate  DateTime?
  quantity         Int
  availableQty     Int
  cost             Decimal           @db.Decimal(10, 2)
  supplier         String?
  location         String?           @db.VarChar(100)
  status           BatchStatus       @default(ACTIVE)
  notes            String?
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  productId        String
  product          Product           @relation(fields: [productId], references: [id])
  batchMovements   BatchMovement[]
  
  @@unique([productId, batchNumber])
  @@map("product_batches")
}

model BatchMovement {
  id              String         @id @default(cuid())
  type            MovementType
  quantity        Int
  reference       String?
  notes           String?
  createdAt       DateTime       @default(now())
  productBatchId  String
  productBatch    ProductBatch   @relation(fields: [productBatchId], references: [id])
  transactionId   String?
  transaction     Transaction?   @relation(fields: [transactionId], references: [id])
  
  @@map("batch_movements")
}

// Tax Management System
model TaxRate {
  id                String           @id @default(cuid())
  code              String           @unique
  name              String
  rate              Decimal          @db.Decimal(5, 2) // Percentage
  type              TaxType
  isActive          Boolean          @default(true)
  effectiveFrom     DateTime         @default(now())
  effectiveTo       DateTime?
  appliesTo         TaxAppliesTo
  jurisdiction      String?          // Country/Region
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt
  branchId          String?
  branch            Branch?          @relation(fields: [branchId], references: [id])
  taxEntries        TaxEntry[]
  configurationsAsDefault TaxConfiguration[]
  
  @@map("tax_rates")
}

model TaxConfiguration {
  id                    String    @id @default(cuid())
  name                  String
  description           String?
  isInclusive           Boolean   @default(false) // true for VAT inclusive pricing
  defaultTaxRateId      String?
  taxExemptCategories   String[]  @default([])
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  branchId              String?
  branch                Branch?   @relation(fields: [branchId], references: [id])
  defaultTaxRate        TaxRate?  @relation(fields: [defaultTaxRateId], references: [id])
  
  @@map("tax_configurations")
}

model TaxEntry {
  id         String     @id @default(cuid())
  taxableAmount Decimal  @db.Decimal(10, 2)
  taxAmount    Decimal  @db.Decimal(10, 2)
  taxRateId    String
  taxRate      TaxRate  @relation(fields: [taxRateId], references: [id])
  entityType   EntityType
  entityId     String
  createdAt    DateTime  @default(now())
  
  @@map("tax_entries")
}

// Stock Alert System
model StockAlert {
  id              String       @id @default(cuid())
  type            AlertType
  severity        AlertSeverity
  title           String
  message         String
  isRead          Boolean      @default(false)
  isResolved      Boolean      @default(false)
  resolvedAt      DateTime?
  resolvedBy      String?
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  productId       String?
  branchId        String?
  branch          Branch?      @relation(fields: [branchId], references: [id])
  product         Product?     @relation(fields: [productId], references: [id])
  
  @@map("stock_alerts")
}

model StockAlertRule {
  id                String       @id @default(cuid())
  name              String
  type              AlertType
  condition         AlertCondition
  threshold         Int
  isActive          Boolean      @default(true)
  notificationMethod NotificationMethod @default(IN_APP)
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt
  branchId          String?
  branch            Branch?      @relation(fields: [branchId], references: [id])
  
  @@map("stock_alert_rules")
}

// Multi-branch Operations
model InterBranchTransfer {
  id                String                    @id @default(cuid())
  transferCode      String                    @unique
  fromBranchId      String
  toBranchId        String
  status            TransferStatus            @default(PENDING)
  totalAmount       Decimal                   @db.Decimal(10, 2)
  notes             String?
  requestedAt       DateTime                  @default(now())
  approvedAt        DateTime?
  shippedAt         DateTime?
  receivedAt        DateTime?
  requestedBy       String
  approvedBy        String?
  shippedBy         String?
  receivedBy        String?
  fromBranch        Branch                    @relation("TransferFrom", fields: [fromBranchId], references: [id])
  toBranch          Branch                    @relation("TransferTo", fields: [toBranchId], references: [id])
  requester         User                      @relation("TransferRequester", fields: [requestedBy], references: [id])
  approver          User?                     @relation("TransferApprover", fields: [approvedBy], references: [id])
  shipper           User?                     @relation("TransferShipper", fields: [shippedBy], references: [id])
  receiver          User?                     @relation("TransferReceiver", fields: [receivedBy], references: [id])
  items             InterBranchTransferItem[]
  
  @@map("inter_branch_transfers")
}

model InterBranchTransferItem {
  id                    String              @id @default(cuid())
  productId             String
  quantity              Int
  unitCost              Decimal             @db.Decimal(10, 2)
  totalCost             Decimal             @db.Decimal(10, 2)
  receivedQuantity      Int                 @default(0)
  status                TransferItemStatus  @default(PENDING)
  transferId            String
  transfer              InterBranchTransfer @relation(fields: [transferId], references: [id], onDelete: Cascade)
  product               Product             @relation(fields: [productId], references: [id])
  
  @@map("inter_branch_transfer_items")
}

enum UserRole {
  ADMIN
  MANAGER
  STAFF
}

enum PaymentMethod {
  CASH
  DEBIT_CARD
  CREDIT_CARD
  QRIS
}

enum TransactionStatus {
  PENDING
  COMPLETED
  CANCELLED
  REFUNDED
}

// Customer Management Enums
enum CustomerGender {
  MALE
  FEMALE
  OTHER
}

enum CustomerType {
  REGULAR
  VIP
  CORPORATE
  WHOLESALE
}

// Contact Management Enums
enum ContactType {
  PHONE
  EMAIL
  ADDRESS
  WEBSITE
  SOCIAL_MEDIA
}

// Loyalty Program Enums
enum LoyaltyPointType {
  EARNED
  REDEEMED
  EXPIRED
  ADJUSTED
}

// Batch & Lot Tracking Enums
enum BatchStatus {
  ACTIVE
  EXPIRED
  QUARANTINED
  CONSUMED
}

enum MovementType {
  IN
  OUT
  ADJUSTMENT
  TRANSFER
  DAMAGE
  EXPIRED
}

// Tax Management Enums
enum TaxType {
  VAT
  GST
  SALES_TAX
  SERVICE_TAX
  IMPORT_DUTY
  OTHER
}

enum TaxAppliesTo {
  PRODUCTS
  SERVICES
  BOTH
  NONE
}

enum EntityType {
  TRANSACTION
  PURCHASE_ORDER
  INVOICE
}

// Stock Alert Enums
enum AlertType {
  LOW_STOCK
  OUT_OF_STOCK
  OVERSTOCK
  EXPIRY_WARNING
  EXPIRED
  DAMAGED
}

enum AlertSeverity {
  INFO
  WARNING
  CRITICAL
}

enum AlertCondition {
  LESS_THAN
  LESS_THAN_OR_EQUAL
  GREATER_THAN
  GREATER_THAN_OR_EQUAL
  EQUAL
}

enum NotificationMethod {
  IN_APP
  EMAIL
  SMS
  WEBHOOK
}

// Multi-branch Transfer Enums
enum TransferStatus {
  PENDING
  APPROVED
  SHIPPED
  RECEIVED
  CANCELLED
}

enum TransferItemStatus {
  PENDING
  APPROVED
  SHIPPED
  RECEIVED
  CANCELLED
}
